<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Barra Libre</title>
<style>
:root{--bg:#000;--surface:rgba(28,28,30,1);--surface2:rgba(44,44,46,1);--surface-glass:rgba(28,28,30,.82);--border:rgba(56,56,58,.6);--text:#f5f5f7;--text2:rgba(235,235,245,.6);--text3:rgba(235,235,245,.3);--accent:#ff9f0a;--accent2:#ff7a00;--green:#30d158;--red:#ff453a;--blue:#0a84ff;--teal:#64d2ff;--radius:12px;--radius-lg:16px;--font:-apple-system,'SF Pro Display','Helvetica Neue',system-ui,sans-serif}
*{margin:0;padding:0;box-sizing:border-box}html{font-size:15px}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100dvh;padding-bottom:84px;-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased}
nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface-glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:.5px solid var(--border);display:flex;z-index:100;padding:6px 0 0;padding-bottom:max(6px,env(safe-area-inset-bottom))}
nav button{flex:1;background:none;border:none;color:var(--text2);padding:4px 4px 2px;font-family:var(--font);font-size:.6rem;font-weight:500;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;transition:color .2s}
nav button.active{color:var(--accent)}nav button svg{width:24px;height:24px;stroke-width:1.8}
header{padding:12px 20px;display:flex;align-items:center;justify-content:space-between;background:var(--surface-glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:.5px solid var(--border);position:sticky;top:0;z-index:60}
header h1{font-size:1.15rem;font-weight:700;letter-spacing:-.01em}header h1 span{color:var(--accent)}
header .phase-badge{font-size:.7rem;font-weight:600;padding:4px 12px;background:rgba(255,159,10,.15);border:1px solid rgba(255,159,10,.3);border-radius:20px;color:var(--accent);cursor:pointer;transition:background .2s}
header .phase-badge:active{background:rgba(255,159,10,.25)}
.section{display:none;padding:16px 20px}.section.active{display:block}
label{display:block;font-size:.7rem;color:var(--text2);margin-bottom:5px;font-weight:500;text-transform:uppercase;letter-spacing:.5px}
select,input[type="date"],input[type="number"],input[type="text"]{width:100%;background:var(--surface2);border:none;color:var(--text);font-family:var(--font);font-size:.9rem;padding:12px 14px;border-radius:10px;outline:none;-webkit-appearance:none;transition:background .2s}
select:focus,input:focus{background:rgba(44,44,46,.8);box-shadow:0 0 0 2px rgba(255,159,10,.4)}
input[type="number"]{font-size:1.1rem;text-align:center;font-weight:600}
textarea{width:100%;background:var(--surface2);border:none;color:var(--text);font-family:var(--font);font-size:.85rem;padding:12px 14px;border-radius:10px;outline:none;resize:vertical;min-height:60px;transition:background .2s}
textarea:focus{background:rgba(44,44,46,.8);box-shadow:0 0 0 2px rgba(255,159,10,.4)}
.row{display:flex;gap:10px;margin-bottom:12px}.row>*{flex:1}.mb{margin-bottom:12px}.mb2{margin-bottom:20px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:var(--accent);color:#000;border:none;font-family:var(--font);font-size:.85rem;font-weight:600;padding:14px 20px;border-radius:12px;cursor:pointer;width:100%;transition:transform .1s,opacity .15s}
.btn:active{transform:scale(.97);opacity:.85}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text);font-weight:500}.btn-outline:active{background:var(--surface2)}
.btn-sm{padding:10px 16px;font-size:.78rem;width:auto}.btn-danger{background:var(--red);color:#fff}
.ex-card{background:var(--surface);border-radius:var(--radius);padding:14px;margin-bottom:10px}
.ex-card .ex-name{font-size:.82rem;font-weight:700;margin-bottom:3px}
.ex-card .ex-target{font-size:.65rem;color:var(--text2);margin-bottom:10px;font-weight:500}
.ex-card .sets-grid{display:grid;grid-template-columns:auto 1fr 1fr;gap:6px 8px;align-items:center}
.ex-card .set-label{font-size:.65rem;color:var(--text3);text-align:center;font-weight:600}
.ex-card input{padding:10px 6px;font-size:1rem;text-align:center;border-radius:8px}
.ex-card .sets-header{font-size:.6rem;color:var(--text3);text-align:center;text-transform:uppercase;letter-spacing:.5px;padding-bottom:2px;font-weight:600}
.ex-card .prev-data{font-size:.65rem;color:var(--text2);margin-top:10px;border-top:.5px solid var(--border);padding-top:8px;font-weight:500}
.ex-card .prev-data span{color:var(--green);font-weight:600}
.timer-bar{position:sticky;top:48px;z-index:50;background:var(--surface-glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:.5px solid var(--border);padding:10px 20px;display:none;align-items:center;gap:8px}
.timer-bar.active{display:flex}
.timer-display{font-size:1.6rem;font-weight:700;flex:1;text-align:center;font-variant-numeric:tabular-nums;letter-spacing:-.02em;transition:color .3s}
.timer-display.warning{color:var(--accent)}.timer-display.done{color:var(--green);animation:pulse .5s ease-in-out 3}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.timer-btn{background:var(--surface2);border:none;color:var(--text2);font-family:var(--font);font-size:.75rem;font-weight:600;padding:7px 14px;border-radius:20px;cursor:pointer;transition:background .2s,color .2s}
.timer-btn:active{background:rgba(255,255,255,.1)}.timer-btn.active-dur{background:rgba(255,159,10,.2);color:var(--accent)}
.timer-start{width:36px;height:36px;border-radius:50%;background:var(--accent);border:none;color:#000;font-size:1rem;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .1s}
.timer-start:active{transform:scale(.9)}.timer-start.running{background:var(--red)}
.cal-container{background:var(--surface);border-radius:var(--radius-lg);padding:16px;margin-bottom:12px}
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.cal-header .cal-title{font-size:.9rem;font-weight:700;letter-spacing:-.01em}
.cal-header .cal-count{font-size:.6rem;color:var(--text2);text-align:right;font-weight:500;text-transform:uppercase;letter-spacing:.5px}
.cal-header .cal-count span{display:block;font-size:1.3rem;font-weight:700;color:var(--accent);letter-spacing:-.02em}
.cal-nav{display:flex;gap:8px;margin-bottom:16px;justify-content:center}
.cal-nav button{background:var(--surface2);border:none;color:var(--text2);font-family:var(--font);font-size:.8rem;font-weight:600;padding:8px 18px;border-radius:20px;cursor:pointer;transition:background .2s}
.cal-nav button:active{background:rgba(255,255,255,.1)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;text-align:center}
.cal-grid .cal-dow{font-size:.6rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;padding-bottom:8px;font-weight:600}
.cal-grid .cal-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:.78rem;border-radius:50%;color:var(--text3);font-weight:500;transition:background .2s}
.cal-grid .cal-day.has-workout{background:var(--accent);color:#000;font-weight:700;cursor:pointer}
.cal-grid .cal-day.has-workout:active{background:var(--accent2);transform:scale(.9)}
.cal-grid .cal-day.today{box-shadow:inset 0 0 0 1.5px var(--text3)}
.cal-grid .cal-day.today.has-workout{box-shadow:inset 0 0 0 2px rgba(255,255,255,.5)}
.cal-grid .cal-day.empty{color:transparent}
.history-item{background:var(--surface);border-radius:var(--radius);padding:14px;margin-bottom:8px;cursor:pointer;transition:transform .1s}
.history-item:active{transform:scale(.98)}
.history-item .hi-date{font-size:.75rem;color:var(--accent);font-weight:700}
.history-item .hi-session{font-size:.68rem;color:var(--text2);font-weight:500;margin-top:1px}
.history-item .hi-summary{font-size:.7rem;color:var(--text);margin-top:6px;line-height:1.4}
.measure-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.measure-row label{flex:1;margin:0;font-size:.72rem;font-weight:500}
.measure-row input{width:85px;flex:none}
.proportion-card{background:var(--surface);border-radius:var(--radius);padding:12px;margin-bottom:8px}
.proportion-card .p-label{font-size:.68rem;color:var(--text2);font-weight:500}
.proportion-card .p-value{font-size:1.1rem;font-weight:700;margin:5px 0;letter-spacing:-.02em}
.proportion-card .p-bar{height:4px;background:var(--surface2);border-radius:2px;overflow:hidden}
.proportion-card .p-fill{height:100%;border-radius:2px;transition:width .4s ease}
.calc-result{background:var(--surface);border-radius:var(--radius);padding:14px;margin-bottom:8px}
.calc-result .cr-label{font-size:.6rem;color:var(--text2);text-transform:uppercase;font-weight:600;letter-spacing:.5px}
.calc-result .cr-value{font-size:1.3rem;font-weight:700;color:var(--accent);letter-spacing:-.02em;margin-top:2px}
.calc-result .cr-sub{font-size:.68rem;color:var(--text2);margin-top:2px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border-radius:16px 16px 0 0;padding:8px 20px 24px;width:100%;max-width:500px;max-height:75vh;overflow-y:auto;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal::before{content:'';display:block;width:36px;height:5px;background:var(--text3);border-radius:3px;margin:8px auto 16px}
.modal h3{font-size:.9rem;font-weight:700;margin-bottom:16px;letter-spacing:-.01em}
.sec-title{font-size:.68rem;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.sec-title-accent{color:var(--accent)}
.phase-option{display:flex;align-items:center;gap:14px;padding:14px;background:var(--surface2);border-radius:var(--radius);margin-bottom:8px;cursor:pointer;transition:background .2s,transform .1s;border:1.5px solid transparent}
.phase-option:active{transform:scale(.98)}
.phase-option.selected{border-color:var(--accent);background:rgba(255,159,10,.08)}
.phase-option .po-num{width:34px;height:34px;border-radius:50%;background:var(--surface);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem}
.phase-option.selected .po-num{background:var(--accent);color:#000}
.phase-option .po-text{font-size:.78rem}
.phase-option .po-title{font-weight:700;margin-bottom:1px}
.phase-option .po-desc{color:var(--text2);font-size:.68rem}
.delete-zone{margin-top:24px;padding-top:16px;border-top:.5px solid var(--border)}
::-webkit-scrollbar{width:0}
@media(min-width:500px){body{max-width:500px;margin:0 auto}nav{max-width:500px;left:50%;transform:translateX(-50%)}}
</style>
</head>
<body>
<header><h1>Barra <span>Libre</span></h1><div class="phase-badge" onclick="openPhaseModal()">Fase <span id="phaseBadge">I</span></div></header>
<div class="timer-bar" id="timerBar">
  <button class="timer-btn" data-dur="60">1:00</button>
  <button class="timer-btn active-dur" data-dur="120">2:00</button>
  <button class="timer-btn" data-dur="180">3:00</button>
  <div class="timer-display" id="timerDisplay">2:00</div>
  <button class="timer-start" id="timerStartBtn" onclick="toggleTimer()">▶</button>
</div>
<div class="section active" id="secTrain">
  <div class="row mb"><div><label>Fecha</label><input type="date" id="trainDate"></div><div><label>Sesión</label><select id="trainSession" onchange="loadSessionTemplate()"></select></div></div>
  <div id="exerciseList"></div>
  <div class="mb"><label>Notas</label><textarea id="trainNotes" placeholder="Sensaciones, fatiga, ajustes..."></textarea></div>
  <button class="btn mb" onclick="saveWorkout()">Guardar sesión</button>
</div>
<div class="section" id="secHistory">
  <div class="cal-nav"><button onclick="calNav(-1)">◀</button><button onclick="calNav(0)" style="flex:1;text-align:center">Hoy</button><button onclick="calNav(1)">▶</button></div>
  <div id="calendarPanel"></div>
  <div class="mb" style="margin-top:12px"><label>Filtrar por sesión</label><select id="historyFilter" onchange="renderHistory()"><option value="">Todas</option></select></div>
  <div id="historyList"></div>
</div>
<div class="section" id="secBody">
  <div class="mb2"><label>Fecha registro</label><input type="date" id="bodyDate"></div>
  <div class="sec-title sec-title-accent">Medidas (cm / kg)</div><div id="bodyMeasures"></div>
  <button class="btn mb2" onclick="saveBodyLog()">Guardar medidas</button>
  <div class="sec-title sec-title-accent">Proporciones Divinas</div><div id="proportionsPanel"></div>
  <div class="sec-title sec-title-accent" style="margin-top:20px">Calorías Estimadas</div>
  <div class="row mb"><div><label>Altura (cm)</label><input type="number" id="calcHeight" value="175" onchange="calcCalories()"></div><div><label>Edad</label><input type="number" id="calcAge" value="32" onchange="calcCalories()"></div></div>
  <div id="caloriesPanel"></div>
  <div class="sec-title sec-title-accent" style="margin-top:20px">Historial Corporal</div><div id="bodyHistory"></div>
</div>
<div class="section" id="secSettings">
  <div class="sec-title sec-title-accent">1RM Estimados</div><div id="rmPanel"></div>
  <div class="sec-title sec-title-accent" style="margin-top:20px">Datos</div>
  <button class="btn btn-outline mb" onclick="exportData()">Exportar JSON</button>
  <button class="btn btn-outline mb" onclick="document.getElementById('importFile').click()">Importar JSON</button>
  <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
  <div class="delete-zone"><button class="btn btn-danger" onclick="clearAllData()">Borrar todos los datos</button></div>
</div>
<div class="modal-overlay" id="phaseModal" onclick="if(event.target===this)closePhaseModal()"><div class="modal"><h3>Seleccionar Fase</h3>
  <div class="phase-option" data-phase="1" onclick="selectPhase(1)"><div class="po-num">I</div><div class="po-text"><div class="po-title">Fuerza</div><div class="po-desc">Full-body · 3×5 · Progresión lineal</div></div></div>
  <div class="phase-option" data-phase="2" onclick="selectPhase(2)"><div class="po-num">II</div><div class="po-text"><div class="po-title">Hipertrofia</div><div class="po-desc">Torso-Pierna · Fuerza + Hipertrofia</div></div></div>
  <div class="phase-option" data-phase="3" onclick="selectPhase(3)"><div class="po-num">III</div><div class="po-text"><div class="po-title">Definición Máxima</div><div class="po-desc">Full-body · Complejos · 4 semanas</div></div></div>
  <div class="phase-option" data-phase="4" onclick="selectPhase(4)"><div class="po-num">IV</div><div class="po-text"><div class="po-title">Ajustes</div><div class="po-desc">Densidad · Zonas retrasadas</div></div></div>
  <button class="btn btn-outline" style="margin-top:8px" onclick="closePhaseModal()">Cerrar</button>
</div></div>
<div class="modal-overlay" id="detailModal" onclick="if(event.target===this)closeDetailModal()"><div class="modal"><h3 id="detailTitle"></h3><div id="detailContent"></div>
  <div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-outline" style="flex:1" onclick="closeDetailModal()">Cerrar</button><button class="btn btn-danger btn-sm" onclick="deleteWorkout()">Eliminar</button></div>
</div></div>
<nav>
  <button class="active" data-sec="secTrain" onclick="switchTab(this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="6.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/><path d="M4 17.5H2V15l3-3h14l3 3v2.5h-2M9 14.5V6M9 6l6 2v6.5"/></svg><span>Entreno</span></button>
  <button data-sec="secHistory" onclick="switchTab(this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v4l3 3M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg><span>Historial</span></button>
  <button data-sec="secBody" onclick="switchTab(this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4zM8 10v4l-3 8M16 10v4l3 8M10 14h4"/></svg><span>Cuerpo</span></button>
  <button data-sec="secSettings" onclick="switchTab(this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg><span>Más</span></button>
</nav>
<script>
// === AUDIO ===
let audioCtx=null;
function getAudioCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}
function playAlarm(){try{const ctx=getAudioCtx(),now=ctx.currentTime;
[0,.25,.5].forEach((offset,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=880+i*220;g.gain.setValueAtTime(.3,now+offset);g.gain.exponentialRampToValueAtTime(.01,now+offset+.2);o.start(now+offset);o.stop(now+offset+.2)});
[1320,1760].forEach(f=>{const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.2,now+.9);g.gain.exponentialRampToValueAtTime(.01,now+1.6);o.start(now+.9);o.stop(now+1.7)});
}catch(e){}}
document.addEventListener('touchstart',function u(){getAudioCtx().resume();document.removeEventListener('touchstart',u)},{once:true});

// === DATA ===
const SK='barraLibre';let DB=loadDB();
function loadDB(){try{const d=JSON.parse(localStorage.getItem(SK));return d&&d.workouts?d:{phase:1,workouts:[],bodyLogs:[],settings:{height:175,age:32}}}catch{return{phase:1,workouts:[],bodyLogs:[],settings:{height:175,age:32}}}}
function saveDB(){localStorage.setItem(SK,JSON.stringify(DB))}

// === PROGRAMS ===
const PROGRAMS={
1:{sessions:{
'Sesión A':[{name:'Sentadilla',sets:3,reps:'5',type:'main'},{name:'Press de Banca',sets:3,reps:'5',type:'main'},{name:'Peso Muerto',sets:2,reps:'5',type:'main'},{name:'Dominada Prono',sets:3,reps:'F',type:'assist'},{name:'Plancha Abdominal',sets:2,reps:'2min',type:'assist'}],
'Sesión B':[{name:'Sentadilla',sets:3,reps:'5',type:'main'},{name:'Press Militar',sets:3,reps:'5',type:'main'},{name:'Clean',sets:5,reps:'3',type:'main'},{name:'Dominada Supino',sets:3,reps:'F',type:'assist'},{name:'Plancha Lateral',sets:2,reps:'1min/lado',type:'assist'}],
'HIIT-1':[{name:'3 Rondas: 10 dom + 20 flex + 30 sent + 40 escaladores + 50 saltos',sets:1,reps:'Tiempo',type:'hiit'}],
'HIIT-2':[{name:'5 Rondas: Sent 1min + Flex 1min + Burpees 1min + Desc 1min',sets:1,reps:'Tiempo',type:'hiit'}],
'HIIT-3 (KB)':[{name:'3 Rondas: 10 thrusters + 15 swings + 20 flex + 30 sent + 15 burpees + 10 snatches',sets:1,reps:'Tiempo',type:'hiit'}],
'HIIT-4 (KB)':[{name:'3 Rondas: 5 snatch/l + 5 thruster/l + 10 flex + 5 high pull/l + 10 dom + 5 squat rack/l + 5 swing/l + 10 burpees + 5 C&P/l + 10 fondos',sets:1,reps:'Tiempo',type:'hiit'}]}},
2:{sessions:{
'Torso Fuerza':[{name:'Press Banca',sets:3,reps:'3-5',type:'main'},{name:'Press Militar',sets:3,reps:'3-5',type:'main'},{name:'Remo con Barra',sets:3,reps:'3-5',type:'main'},{name:'Press Jabalina',sets:3,reps:'3-5/lado',type:'main'},{name:'Dominada Supino',sets:3,reps:'5-8',type:'assist'},{name:'Fondos Paralelas',sets:3,reps:'5-8',type:'assist'},{name:'Encogimientos',sets:2,reps:'8-10',type:'extra'}],
'Pierna Fuerza':[{name:'Sentadilla',sets:3,reps:'3-5',type:'main'},{name:'Peso Muerto',sets:3,reps:'3-5',type:'main'},{name:'Elev. Piernas a Barra',sets:3,reps:'8-10',type:'assist'},{name:'Sit-up con Barra',sets:3,reps:'5',type:'assist'},{name:'Sentadilla 1 pierna',sets:2,reps:'5/lado',type:'extra'}],
'Torso Hipertrofia':[{name:'Press Militar',sets:4,reps:'8-10',type:'main'},{name:'Press Banca',sets:4,reps:'8-10',type:'main'},{name:'Dominada Prono',sets:3,reps:'F',type:'assist'},{name:'Flexiones con Palmada',sets:4,reps:'15',type:'assist'},{name:'Curl con Barra',sets:4,reps:'10-12',type:'assist'},{name:'Curl Invertido',sets:2,reps:'10-12',type:'extra'}],
'Pierna Hipertrofia':[{name:'Sentadilla Frontal',sets:4,reps:'8-10',type:'main'},{name:'Peso Muerto Rumano',sets:4,reps:'8-10',type:'main'},{name:'Desplantes con Barra',sets:4,reps:'8-10',type:'main'},{name:'Elevación Talones',sets:4,reps:'10-15',type:'assist'},{name:'Roll-out',sets:4,reps:'10',type:'assist'},{name:'PM Unilateral',sets:2,reps:'6-8/lado',type:'extra'}],
'Potencia + HIIT':[{name:'Clean',sets:5,reps:'3',type:'main'},{name:'HIIT (rotar 1-4)',sets:1,reps:'Tiempo',type:'hiit'}]}},
3:{sessions:{
'Sesión A':[{name:'Peso Muerto',sets:3,reps:'4-6',type:'main'},{name:'Press de Banca',sets:3,reps:'4-6',type:'main'},{name:'Press Militar',sets:3,reps:'4-6',type:'main'},{name:'Dominadas',sets:4,reps:'F',type:'assist'},{name:'Sit-ups con Barra',sets:3,reps:'5',type:'extra'}],
'Sesión B':[{name:'Sentadilla',sets:3,reps:'4-6',type:'main'},{name:'Remo con Barra',sets:3,reps:'4-6',type:'main'},{name:'Sentadilla Frontal',sets:3,reps:'4-6',type:'main'},{name:'Fondos Paralelas',sets:4,reps:'F',type:'assist'},{name:'Roll-out con Barra',sets:3,reps:'10',type:'extra'}],
'COM-1':[{name:'4 Rondas: 5 rows + 5 cleans + 5 sent frontal + 5 push press + 5 sent',sets:1,reps:'Tiempo',type:'hiit'}],
'COM-2':[{name:'4 Rondas: 6 PM rumano + 6 rows + 6 cleans + 6 push press + 6 desplantes',sets:1,reps:'Tiempo',type:'hiit'}],
'GUERR-1':[{name:'COM-1 + 20min cardio + HIIT calistenia',sets:1,reps:'Tiempo',type:'hiit'}],
'GUERR-2':[{name:'COM-2 + 20min cardio + HIIT calistenia',sets:1,reps:'Tiempo',type:'hiit'}]}},
4:{sessions:{
'Densidad A':[{name:'Bloque 1 (10min): Press Militar + Dominada',sets:1,reps:'Total reps',type:'density'},{name:'Bloque 2 (10min): Press Banca + Remo Invertido',sets:1,reps:'Total reps',type:'density'},{name:'Retraso Zona 1 - Ej.1',sets:4,reps:'8-12',type:'main'},{name:'Retraso Zona 1 - Ej.2',sets:4,reps:'8-12',type:'main'},{name:'Retraso Zona 1 - Ej.3',sets:4,reps:'8-12',type:'extra'}],
'Densidad B':[{name:'Bloque 1 (5min): Peso Muerto o Sentadilla',sets:1,reps:'Total reps',type:'density'},{name:'Bloque 2 (10min): Sent Frontal + Swing/Elev Piernas',sets:1,reps:'Total reps',type:'density'},{name:'Retraso Zona 2 - Ej.1',sets:4,reps:'8-12',type:'main'},{name:'Retraso Zona 2 - Ej.2',sets:4,reps:'8-12',type:'main'},{name:'Retraso Zona 2 - Ej.3',sets:4,reps:'8-12',type:'extra'}]}}
};
const BODY_MEASURES=[{id:'peso',label:'Peso (kg)'},{id:'grasa',label:'% Grasa'},{id:'muneca',label:'Muñeca'},{id:'biceps',label:'Bíceps'},{id:'pecho',label:'Pecho'},{id:'hombros',label:'Hombros'},{id:'cintura',label:'Cintura'},{id:'cuello',label:'Cuello'},{id:'muslo',label:'Muslo'},{id:'rodilla',label:'Rodilla'},{id:'pantorrilla',label:'Pantorrilla'}];

// === NAV ===
function switchTab(btn){
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  btn.classList.add('active');document.getElementById(btn.dataset.sec).classList.add('active');
  document.getElementById('timerBar').classList.toggle('active',btn.dataset.sec==='secTrain');
  if(btn.dataset.sec==='secHistory'){renderCalendar();renderHistory()}
  if(btn.dataset.sec==='secBody'){renderBodyForm();renderBodyHistory();calcProportions();calcCalories()}
  if(btn.dataset.sec==='secSettings')render1RMs();
}

// === PHASE ===
function openPhaseModal(){document.getElementById('phaseModal').classList.add('open');updatePhaseUI()}
function closePhaseModal(){document.getElementById('phaseModal').classList.remove('open')}
function selectPhase(n){DB.phase=n;saveDB();document.getElementById('phaseBadge').textContent=['I','II','III','IV'][n-1];updatePhaseUI();populateSessions();closePhaseModal()}
function updatePhaseUI(){document.querySelectorAll('.phase-option').forEach(el=>el.classList.toggle('selected',parseInt(el.dataset.phase)===DB.phase))}

// === TRAINING ===
function populateSessions(){
  const sel=document.getElementById('trainSession'),fsel=document.getElementById('historyFilter'),ss=Object.keys(PROGRAMS[DB.phase].sessions);
  sel.innerHTML=ss.map(s=>`<option value="${s}">${s}</option>`).join('');
  fsel.innerHTML='<option value="">Todas</option>'+ss.map(s=>`<option value="${s}">${s}</option>`).join('');
  loadSessionTemplate();
}
function loadSessionTemplate(){
  const session=document.getElementById('trainSession').value,exercises=PROGRAMS[DB.phase].sessions[session];
  if(!exercises)return;const container=document.getElementById('exerciseList'),prev=getPrevSession(session);
  container.innerHTML=exercises.map((ex,i)=>{
    const isH=ex.type==='hiit'||ex.type==='density',prevEx=prev?prev.exercises[i]:null;
    if(isH){const pi=prevEx?`<div class="prev-data">Anterior: <span>${prevEx.sets[0]?.reps||'—'}</span></div>`:'';
      return `<div class="ex-card"><div class="ex-name">${ex.name}</div><div style="margin-top:8px"><label>Resultado</label><input type="text" data-ex="${i}" data-set="0" data-field="reps" placeholder="Tiempo / reps totales"></div>${pi}</div>`}
    let sh=`<div class="sets-grid"><div></div><div class="sets-header">Kg</div><div class="sets-header">Reps</div>`;
    for(let s=0;s<ex.sets;s++){const pK=prevEx?.sets[s]?.kg??'',pR=prevEx?.sets[s]?.reps??'';
      sh+=`<div class="set-label">S${s+1}</div><input type="number" data-ex="${i}" data-set="${s}" data-field="kg" placeholder="${pK||'—'}" step="0.5"><input type="text" data-ex="${i}" data-set="${s}" data-field="reps" placeholder="${pR||ex.reps}" inputmode="numeric">`}
    sh+='</div>';const pi=prevEx?`<div class="prev-data">Anterior: ${prevEx.sets.map(s=>`<span>${s.kg||'—'}×${s.reps||'—'}</span>`).join(' · ')}</div>`:'';
    return `<div class="ex-card"><div class="ex-name">${ex.name}</div><div class="ex-target">${ex.sets}×${ex.reps}${ex.type==='extra'?' (extra)':''}</div>${sh}${pi}</div>`}).join('');
}
function getPrevSession(n){const f=DB.workouts.filter(w=>w.session===n&&w.phase===DB.phase);return f.length?f[f.length-1]:null}
function saveWorkout(){
  const date=document.getElementById('trainDate').value,session=document.getElementById('trainSession').value,notes=document.getElementById('trainNotes').value,exercises=PROGRAMS[DB.phase].sessions[session];
  const exData=exercises.map((ex,i)=>{const sets=[];for(let s=0;s<ex.sets;s++){const k=document.querySelector(`[data-ex="${i}"][data-set="${s}"][data-field="kg"]`),r=document.querySelector(`[data-ex="${i}"][data-set="${s}"][data-field="reps"]`);sets.push({kg:k?k.value:'',reps:r?r.value:''})}return{name:ex.name,sets}});
  DB.workouts.push({id:Date.now(),date,session,phase:DB.phase,notes,exercises:exData});saveDB();
  document.getElementById('trainNotes').value='';loadSessionTemplate();
  const btn=document.querySelector('#secTrain .btn'),o=btn.textContent;btn.textContent='✓ Guardado';btn.style.background='var(--green)';setTimeout(()=>{btn.textContent=o;btn.style.background=''},1200);
}

// === CALENDAR ===
let calViewDate=new Date();
function calNav(d){if(d===0)calViewDate=new Date();else calViewDate.setMonth(calViewDate.getMonth()+d);renderCalendar()}
function renderCalendar(){
  const panel=document.getElementById('calendarPanel'),now=new Date(),todayStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  const wd={};DB.workouts.forEach(w=>{if(!wd[w.date])wd[w.date]=[];wd[w.date].push(w.session)});
  const vm=new Date(calViewDate.getFullYear(),calViewDate.getMonth(),1),pm=new Date(calViewDate.getFullYear(),calViewDate.getMonth()-1,1);
  let html='';const DOW=['L','M','X','J','V','S','D'],MN=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  [pm,vm].forEach(md=>{const y=md.getFullYear(),m=md.getMonth(),dim=new Date(y,m+1,0).getDate();let fd=new Date(y,m,1).getDay();fd=fd===0?6:fd-1;
    let mc=0;for(let d=1;d<=dim;d++){const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;if(wd[ds])mc++}
    html+=`<div class="cal-container"><div class="cal-header"><div class="cal-title">${MN[m]} ${y}</div><div class="cal-count">Sesiones<span>${mc}</span></div></div><div class="cal-grid">`;
    DOW.forEach(d=>{html+=`<div class="cal-dow">${d}</div>`});
    for(let e=0;e<fd;e++)html+='<div class="cal-day empty">·</div>';
    for(let d=1;d<=dim;d++){const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`,hw=wd[ds],it=ds===todayStr;let c='cal-day';if(hw)c+=' has-workout';if(it)c+=' today';const oc=hw?` onclick="calDayClick('${ds}')"`:'';html+=`<div class="${c}"${oc}>${d}</div>`}
    html+='</div></div>'});
  panel.innerHTML=html;
}
function calDayClick(ds){const ws=DB.workouts.filter(w=>w.date===ds);if(ws.length===1)showDetail(ws[0].id);else if(ws.length>1){document.getElementById('historyFilter').value='';renderHistory(ds)}}

// === HISTORY ===
let detailWorkoutId=null;
function renderHistory(dateFilter){
  const filter=document.getElementById('historyFilter').value;let items=[...DB.workouts].reverse();
  if(filter)items=items.filter(w=>w.session===filter);if(dateFilter)items=items.filter(w=>w.date===dateFilter);
  document.getElementById('historyList').innerHTML=items.length===0?'<p style="color:var(--text2);font-size:.8rem;text-align:center;padding:40px 0">Sin registros aún</p>':items.map(w=>{
    const summary=w.exercises.filter(e=>e.sets.some(s=>s.kg)).map(e=>`${e.name}: ${e.sets.map(s=>`${s.kg||'—'}×${s.reps||'—'}`).join(', ')}`).join(' · ');
    const hs=w.exercises.filter(e=>!e.sets.some(s=>s.kg)&&e.sets[0]?.reps).map(e=>e.sets[0].reps).join(' · ');
    return `<div class="history-item" onclick="showDetail(${w.id})"><div class="hi-date">${formatDate(w.date)}</div><div class="hi-session">Fase ${['I','II','III','IV'][w.phase-1]} · ${w.session}</div><div class="hi-summary">${summary||hs||'—'}</div></div>`}).join('');
}
function showDetail(id){
  detailWorkoutId=id;const w=DB.workouts.find(x=>x.id===id);if(!w)return;
  document.getElementById('detailTitle').textContent=`${formatDate(w.date)} — ${w.session}`;
  let html=w.exercises.map(e=>{const ss=e.sets.map((s,i)=>`<span style="color:var(--text)">S${i+1}: ${s.kg||'—'}kg × ${s.reps||'—'}</span>`).join('<br>');return `<div style="margin-bottom:14px"><div style="font-size:.78rem;color:var(--accent);font-weight:700">${e.name}</div><div style="font-size:.8rem;margin-top:4px;line-height:1.5">${ss}</div></div>`}).join('');
  if(w.notes)html+=`<div style="margin-top:10px;padding-top:10px;border-top:.5px solid var(--border);font-size:.75rem;color:var(--text2)">${w.notes}</div>`;
  document.getElementById('detailContent').innerHTML=html;document.getElementById('detailModal').classList.add('open');
}
function closeDetailModal(){document.getElementById('detailModal').classList.remove('open')}
function deleteWorkout(){if(!confirm('¿Eliminar este registro?'))return;DB.workouts=DB.workouts.filter(w=>w.id!==detailWorkoutId);saveDB();closeDetailModal();renderHistory();renderCalendar()}

// === BODY ===
function renderBodyForm(){const last=DB.bodyLogs.length?DB.bodyLogs[DB.bodyLogs.length-1]:{};document.getElementById('bodyMeasures').innerHTML=BODY_MEASURES.map(m=>`<div class="measure-row"><label>${m.label}</label><input type="number" id="bm_${m.id}" step="0.1" placeholder="${last[m.id]||'—'}"></div>`).join('')}
function saveBodyLog(){const date=document.getElementById('bodyDate').value,entry={date,id:Date.now()};let has=false;BODY_MEASURES.forEach(m=>{const v=document.getElementById('bm_'+m.id).value;if(v){entry[m.id]=parseFloat(v);has=true}});if(!has)return alert('Introduce al menos una medida');DB.bodyLogs.push(entry);saveDB();renderBodyForm();renderBodyHistory();calcProportions();calcCalories()}
function renderBodyHistory(){const logs=[...DB.bodyLogs].reverse().slice(0,10);document.getElementById('bodyHistory').innerHTML=logs.length===0?'<p style="color:var(--text2);font-size:.8rem;text-align:center;padding:20px 0">Sin registros</p>':logs.map(l=>{const vals=BODY_MEASURES.filter(m=>l[m.id]).map(m=>`${m.label}: ${l[m.id]}`).join(' · ');return `<div class="history-item"><div class="hi-date">${formatDate(l.date)}</div><div class="hi-summary">${vals}</div></div>`}).join('')}
function calcProportions(){
  const last=getLatestBodyData();if(!last.muneca){document.getElementById('proportionsPanel').innerHTML='<p style="color:var(--text2);font-size:.8rem">Registra muñeca para calcular</p>';return}
  const ps=[{label:'Brazo / Muñeca',current:last.biceps,target:last.muneca*2.5,tl:`${(last.muneca*2.5).toFixed(1)}cm (2.5×)`,has:!!last.biceps},{label:'Pecho / Muñeca',current:last.pecho,target:last.muneca*6.5,tl:`${(last.muneca*6.5).toFixed(1)}cm (6.5×)`,has:!!last.pecho},{label:'Hombros / Cintura',current:last.hombros,target:last.cintura*1.618,tl:`${(last.cintura*1.618).toFixed(1)}cm (φ)`,has:!!(last.hombros&&last.cintura)},{label:'Pantorrilla ≈ Bíceps',current:last.pantorrilla,target:last.biceps,tl:`${last.biceps||'—'}cm`,has:!!(last.pantorrilla&&last.biceps)},{label:'Muslo / Rodilla',current:last.muslo,target:last.rodilla*1.618,tl:`${((last.rodilla||0)*1.618).toFixed(1)}cm (φ)`,has:!!(last.muslo&&last.rodilla)}];
  document.getElementById('proportionsPanel').innerHTML=ps.map(p=>{if(!p.has)return `<div class="proportion-card"><div class="p-label">${p.label}</div><div class="p-value" style="color:var(--text3);font-size:.8rem">Faltan medidas</div></div>`;const pct=Math.min((p.current/p.target)*100,120),color=pct>=95&&pct<=105?'var(--green)':pct<95?'var(--accent)':'var(--teal)';return `<div class="proportion-card"><div class="p-label">${p.label}</div><div class="p-value" style="color:${color}">${p.current.toFixed(1)}cm <span style="font-size:.68rem;color:var(--text2)">/ ${p.tl}</span></div><div class="p-bar"><div class="p-fill" style="width:${Math.min(pct,100)}%;background:${color}"></div></div></div>`}).join('');
}
function getLatestBodyData(){const r={};[...DB.bodyLogs].reverse().forEach(l=>{BODY_MEASURES.forEach(m=>{if(!r[m.id]&&l[m.id])r[m.id]=l[m.id]})});return r}
function calcCalories(){const last=getLatestBodyData(),h=parseFloat(document.getElementById('calcHeight').value)||175,age=parseFloat(document.getElementById('calcAge').value)||32,peso=last.peso||70,grasa=last.grasa||15;const t1=10*peso+6.25*h-5*age+5,lbm=peso*(1-grasa/100),t2=370+21.6*lbm,tmb=(t1+t2)/2,m=tmb*1.65;document.getElementById('caloriesPanel').innerHTML=`<div class="calc-result"><div class="cr-label">TMB (media)</div><div class="cr-value">${Math.round(tmb)} kcal</div><div class="cr-sub">Peso: ${peso}kg · Grasa: ${grasa}%</div></div><div class="calc-result"><div class="cr-label">Mantenimiento (×1.65)</div><div class="cr-value">${Math.round(m)} kcal</div></div><div class="calc-result"><div class="cr-label">Volumen (+10-15%)</div><div class="cr-value">${Math.round(m*1.1)} – ${Math.round(m*1.15)} kcal</div></div><div class="calc-result"><div class="cr-label">Definición (-15%)</div><div class="cr-value">${Math.round(m*.85)} kcal</div></div><div class="calc-result"><div class="cr-label">Def. Máxima (×22/kg)</div><div class="cr-value">${Math.round(peso*22)} kcal</div></div>`}

// === 1RM ===
function render1RMs(){const lifts={};DB.workouts.forEach(w=>{w.exercises.forEach(ex=>{const n=normLift(ex.name);if(!n)return;ex.sets.forEach(s=>{const kg=parseFloat(s.kg),reps=parseInt(s.reps);if(!kg||!reps||reps<1)return;const rm=kg*reps*.0333+kg;if(!lifts[n]||rm>lifts[n].rm)lifts[n]={rm,kg,reps,date:w.date}})})});const p=document.getElementById('rmPanel'),k=Object.keys(lifts);if(!k.length){p.innerHTML='<p style="color:var(--text2);font-size:.8rem;text-align:center;padding:20px 0">Registra entrenamientos para ver 1RM</p>';return}p.innerHTML=k.map(n=>`<div class="calc-result"><div class="cr-label">${n}</div><div class="cr-value">${lifts[n].rm.toFixed(1)} kg</div><div class="cr-sub">Basado en ${lifts[n].kg}kg × ${lifts[n].reps} (${formatDate(lifts[n].date)})</div></div>`).join('')}
function normLift(name){const n=name.toLowerCase();if(n.includes('sentadilla')&&!n.includes('frontal')&&!n.includes('1 pierna'))return'Sentadilla';if(n.includes('press')&&(n.includes('banca')||n.includes('bench')))return'Press Banca';if(n.includes('press')&&n.includes('militar'))return'Press Militar';if(n.includes('peso muerto')&&!n.includes('rumano')&&!n.includes('unilateral'))return'Peso Muerto';if(n==='clean')return'Clean';if(n.includes('remo'))return'Remo con Barra';return null}

// === TIMER ===
let timerInterval=null,timerSeconds=120,timerRunning=false,timerDuration=120;
document.querySelectorAll('.timer-btn[data-dur]').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.timer-btn[data-dur]').forEach(b=>b.classList.remove('active-dur'));btn.classList.add('active-dur');timerDuration=parseInt(btn.dataset.dur);if(!timerRunning){timerSeconds=timerDuration;updateTimerDisplay()}})});
function toggleTimer(){if(audioCtx)audioCtx.resume();if(timerRunning)stopTimer();else startTimer()}
function startTimer(){timerSeconds=timerDuration;timerRunning=true;const btn=document.getElementById('timerStartBtn');btn.textContent='⏹';btn.classList.add('running');updateTimerDisplay();
  timerInterval=setInterval(()=>{timerSeconds--;updateTimerDisplay();if(timerSeconds<=0){stopTimer();const d=document.getElementById('timerDisplay');d.classList.add('done');d.textContent='¡GO!';playAlarm();if(navigator.vibrate)navigator.vibrate([200,100,200,100,200]);setTimeout(()=>{d.classList.remove('done');timerSeconds=timerDuration;updateTimerDisplay()},3000)}},1000)}
function stopTimer(){clearInterval(timerInterval);timerRunning=false;const btn=document.getElementById('timerStartBtn');btn.textContent='▶';btn.classList.remove('running');timerSeconds=timerDuration;updateTimerDisplay();document.getElementById('timerDisplay').classList.remove('warning','done')}
function updateTimerDisplay(){const m=Math.floor(timerSeconds/60),s=timerSeconds%60;const d=document.getElementById('timerDisplay');d.textContent=`${m}:${s.toString().padStart(2,'0')}`;d.classList.toggle('warning',timerSeconds<=10&&timerSeconds>0)}

// === EXPORT ===
function exportData(){const b=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`barra-libre-${new Date().toISOString().slice(0,10)}.json`;a.click()}
function importData(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const d=JSON.parse(r.result);if(d.workouts){DB=d;saveDB();alert('Datos importados');location.reload()}else alert('Formato no válido')}catch{alert('Error al leer')}};r.readAsText(f)}
function clearAllData(){if(!confirm('¿Borrar TODOS los datos?'))return;if(!confirm('Última oportunidad. ¿Borrar todo?'))return;localStorage.removeItem(SK);location.reload()}

// === UTILS ===
function formatDate(d){if(!d)return'—';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d}
function today(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}

// === SEED & INIT ===
function seedInitialData(){if(DB.workouts.length>0)return;DB.workouts.push({id:1739145600000,date:'2026-02-09',session:'Sesión A',phase:1,notes:'Primera sesión',exercises:[{name:'Sentadilla',sets:[{kg:'65',reps:'5'},{kg:'65',reps:'5'},{kg:'65',reps:'5'}]},{name:'Press de Banca',sets:[{kg:'50',reps:'5'},{kg:'50',reps:'5'},{kg:'50',reps:'5'}]},{name:'Peso Muerto',sets:[{kg:'70',reps:'5'},{kg:'70',reps:'5'}]},{name:'Dominada Prono',sets:[{kg:'',reps:'14'},{kg:'',reps:'11'},{kg:'',reps:'8'}]},{name:'Plancha Abdominal',sets:[{kg:'',reps:'2min'},{kg:'',reps:'2min'}]}]});saveDB()}
function init(){seedInitialData();document.getElementById('trainDate').value=today();document.getElementById('bodyDate').value=today();document.getElementById('phaseBadge').textContent=['I','II','III','IV'][DB.phase-1];document.getElementById('calcHeight').value=DB.settings?.height||175;document.getElementById('calcAge').value=DB.settings?.age||32;document.getElementById('timerBar').classList.add('active');populateSessions()}
init();
</script>
</body>
</html>
